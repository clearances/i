<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Connect with Discord</title>
  <style>
    body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin-top: 100px; }
    #username-section { display: none; flex-direction: column; gap: 10px; margin-top: 20px; }
    input, button { padding: 10px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>Connect Your Discord</h1>
  <a href="https://discord.com/oauth2/authorize?client_id=1361047871041966311&response_type=code&redirect_uri=https%3A%2F%2Finternetknown.space%2Foauth%2Fcallback&scope=identify">
    <button>Connect Discord</button>
  </a>

  <div id="username-section">
    <p>Welcome <span id="discord-name"></span>!</p>
    <input type="text" id="username" placeholder="Choose a username" />
    <button onclick="submitUsername()">Submit</button>
  </div>

  <script>
    async function fetchUserData(code) {
      // This must be done through your backend due to the client secret!
      const response = await fetch('/oauth/callback?code=' + code);
      const data = await response.json();
      return data;
    }

    async function submitUsername() {
      const username = document.getElementById('username').value;
      const discordId = window.discordId;
      const discordTag = window.discordTag;

      if (!username || !discordId) return alert('Missing info');

      const payload = {
        content: `New user signed up:\nUsername: **${username}**\nDiscord: ${discordTag} (ID: ${discordId})`
      };

      await fetch("https://discord.com/api/webhooks/1361046832876097579/Uq1jFpa-nIIV8g5rONJgkBahRVhjlygqfiEo3EGUsXAZWVHE3xRiKRAPVIP_t0NCZy2K", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      alert("Username submitted!");
    }

    // OAuth2 flow
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    if (code) {
      fetchUserData(code).then(user => {
        window.discordId = user.id;
        window.discordTag = `${user.username}#${user.discriminator}`;
        document.getElementById('discord-name').textContent = window.discordTag;
        document.getElementById('username-section').style.display = 'flex';
      });
    }
  </script>
</body>
</html>
